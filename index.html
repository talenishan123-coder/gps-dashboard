<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ESP32 GPS Tracker – ThingsBoard + Google Maps</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html,body,#map{height:100%;margin:0;padding:0}
    #info{
      position:absolute;top:10px;left:10px;z-index:5;
      background:#fff;padding:10px;border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.2);
      font-family:Arial,sans-serif;font-size:13px;
      max-width:300px
    }
  </style>
</head>
<body>
  <div id="info">
    <strong>Device ID:</strong> 3b7e5ab0-a1e3-11f0-91df-7ffa16af2ee9<br>
    <span id="status">Waiting for first update…</span>
  </div>
  <div id="map"></div>

  <script>
    const DEVICE_ID = "3b7e5ab0-a1e3-11f0-91df-7ffa16af2ee9";
    const API_URL = `https://thingsboard.cloud/api/plugins/telemetry/DEVICE/${DEVICE_ID}/values/timeseries?keys=latitude,longitude`;
    const REFRESH_MS = 5000;

    let jwt = null;
    let map, marker;

    async function fetchLocation() {
      if (!jwt) return;
      try {
        const res = await fetch(API_URL, { headers: { Authorization: "Bearer " + jwt }});
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        const data = await res.json();
        const lat = parseFloat(data.latitude?.[0]?.value);
        const lon = parseFloat(data.longitude?.[0]?.value);
        if (isFinite(lat) && isFinite(lon)) {
          updateMap(lat, lon);
          document.getElementById("status").textContent =
            `Last update: ${new Date().toLocaleTimeString()}  (${lat.toFixed(5)}, ${lon.toFixed(5)})`;
        } else {
          document.getElementById("status").textContent = "No valid latitude/longitude yet";
        }
      } catch (e) {
        document.getElementById("status").textContent = "Fetch error: " + e.message;
      }
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 20.5937, lng: 78.9629 }, // India default
        zoom: 5
      });
      marker = new google.maps.Marker({ map });
      fetchLocation();
      setInterval(fetchLocation, REFRESH_MS);
    }

    function updateMap(lat, lon) {
      const pos = { lat, lng: lon };
      marker.setPosition(pos);
      map.setCenter(pos);
      map.setZoom(15);
    }

    window.addEventListener("load", () => {
      jwt = prompt("Enter your ThingsBoard JWT token:");
      if (!jwt) document.getElementById("status").textContent = "JWT token required.";
    });
  </script>

  <!-- Load Google Maps -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBprDArL1awD1RY3TFBpvoCeFn_OvG0Mqg&callback=initMap">
  </script>
</body>
</html>
